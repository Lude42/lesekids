<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Lesekids – Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --gap: 14px;
      --pad: 12px;
      --border: 1px solid #e3e3e3;
      --muted: #666;
      --ok: #2e7d32;
      --err: #c62828;
    }
    body { font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 24px; background: #fafafa; }
    .wrap { max-width: 1200px; margin: 0 auto; background: #fff; border: var(--border); border-radius: 10px; padding: 22px; box-shadow: 0 4px 16px rgba(0,0,0,.05);}
    h1 { margin: 0 0 10px; font-size: 22px; }
    .toolbar { display: grid; grid-template-columns: 160px 1fr 1fr auto auto; gap: var(--gap); align-items: end; margin-bottom: 18px; }
    label { font-weight: 600; display: block; margin-bottom: 6px; }
    input[type="text"], input[type="number"], textarea, select {
      width: 100%; box-sizing: border-box; padding: var(--pad);
      border: var(--border); border-radius: 8px; background: #fff;
    }
    textarea { min-height: 120px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .panel { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); align-items: start; }
    .preview { border: var(--border); border-radius: 8px; padding: var(--pad); background: #fcfcfc; min-height: 120px; overflow: auto; }
    .muted { color: var(--muted); font-size: 13px; }
    .row { margin-top: 18px; }
    .options { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--gap); }
    .opt { display: grid; grid-template-rows: auto auto; gap: 8px; }
    .inline { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--gap); }
    .actions { margin-top: 16px; display: flex; gap: 10px; }
    button { padding: 10px 14px; border-radius: 8px; border: var(--border); background: #0ea5e9; color: #fff; cursor: pointer; }
    button.secondary { background: #e0e7ff; color: #1e3a8a; }
    #msg { margin-top: 10px; }
    #msg.ok { color: var(--ok); }
    #msg.err { color: var(--err); }
    .badge { display:inline-block; padding:2px 8px; border-radius: 999px; font-size:12px; background:#eef2ff; color:#3730a3; }

    /* Tooltip-Stile – funktionieren in der Vorschau per :hover und :focus-within */
    .tooltip { position: relative; cursor: pointer; border-bottom: 1px dotted rgba(0,0,0,.35); }
    .tooltip .tooltiptext {
      visibility: hidden; opacity: 0; transition: opacity .2s ease;
      position: absolute; z-index: 10; top: 100%; left: 0;
      width: 240px; padding: 10px; border-radius: 8px;
      background: rgba(0,0,0,.85); color: #fff; text-align: left;
      box-shadow: 0 6px 16px rgba(0,0,0,.2);
    }
    .tooltip:hover .tooltiptext,
    .tooltip:focus-within .tooltiptext { visibility: visible; opacity: 1; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Lesekids – Admin <span class="badge">Items bearbeiten</span></h1>

    <div class="toolbar">
      <div>
        <label for="itemId">Item-ID</label>
        <input id="itemId" type="number" min="1" placeholder="z. B. 120">
      </div>
      <div>
        <label for="adminToken">Admin-Token (Bearer)</label>
        <input id="adminToken" type="text" placeholder="Token…">
      </div>
      <div>
        <label for="type">Typ</label>
        <select id="type">
          <option value="mc">mc (Multiple Choice)</option>
          <option value="open">open (Offen)</option>
        </select>
      </div>
      <div><button id="load" class="secondary">Laden</button></div>
      <div><button id="save">Speichern</button></div>
    </div>

    <!-- que -->
    <div class="row">
      <div class="panel">
        <div>
          <label for="que">que</label>
          <textarea id="que" placeholder="HTML/Text…"></textarea>
          <div class="muted">Hauptfrage (HTML erlaubt). In Produktion bitte serverseitig sanitizen.</div>
        </div>
        <div>
          <label>Vorschau que</label>
          <div id="prev-que" class="preview"></div>
        </div>
      </div>
    </div>

    <!-- que2a -->
    <div class="row">
      <div class="panel">
        <div>
          <label for="que2a">que2a</label>
          <textarea id="que2a"></textarea>
          <div class="muted">Nachfrage A</div>
        </div>
        <div>
          <label>Vorschau que2a</label>
          <div id="prev-que2a" class="preview"></div>
        </div>
      </div>
    </div>

    <!-- tbar (TTS für que2a) -->
    <div class="row">
      <div class="panel">
        <div>
          <label for="tbar">tbar (TTS-Text zu que2a)</label>
          <textarea id="tbar" placeholder="Vorlesetext zu que2a (Plain Text) …"></textarea>
          <div class="muted">Reiner Text, ohne HTML (für Text-to-Speech optimiert).</div>
        </div>
        <div>
          <label>Vorschau tbar</label>
          <div id="prev-tbar" class="preview"></div>
        </div>
      </div>
    </div>

    <!-- que2b -->
    <div class="row">
      <div class="panel">
        <div>
          <label for="que2b">que2b</label>
          <textarea id="que2b"></textarea>
          <div class="muted">Nachfrage B</div>
        </div>
        <div>
          <label>Vorschau que2b</label>
          <div id="prev-que2b" class="preview"></div>
        </div>
      </div>
    </div>

    <!-- tts_que2b (TTS für que2b) -->
    <div class="row">
      <div class="panel">
        <div>
          <label for="tts_que2b">tts_que2b (TTS-Text zu que2b)</label>
          <textarea id="tts_que2b" placeholder="Vorlesetext zu que2b (Plain Text) …"></textarea>
          <div class="muted">Reiner Text, ohne HTML (für Text-to-Speech optimiert).</div>
        </div>
        <div>
          <label>Vorschau tts_que2b</label>
          <div id="prev-tts_que2b" class="preview"></div>
        </div>
      </div>
    </div>

    <!-- Optionen & Feedback -->
    <div class="row">
      <label>Antwortoptionen & Feedback</label>
      <div class="options">
        <div class="opt">
          <input id="opt1" type="text" placeholder="opt1">
          <textarea id="fb1" placeholder="Feedback zu opt1"></textarea>
        </div>
        <div class="opt">
          <input id="opt2" type="text" placeholder="opt2">
          <textarea id="fb2" placeholder="Feedback zu opt2"></textarea>
        </div>
        <div class="opt">
          <input id="opt3" type="text" placeholder="opt3">
          <textarea id="fb3" placeholder="Feedback zu opt3"></textarea>
        </div>
        <div class="opt">
          <input id="opt4" type="text" placeholder="opt4">
          <textarea id="fb4" placeholder="Feedback zu opt4"></textarea>
        </div>
      </div>
    </div>

    <!-- Metadaten -->
    <div class="row inline">
      <div>
        <label for="cor">Korrekte Option (Index; 1–4)</label>
        <input id="cor" type="number" min="1" max="4" value="1">
      </div>
      <div>
        <label for="accept">accept (kommasepariert)</label>
        <input id="accept" type="text" placeholder="z. B. Giraffe, die Giraffe, …">
      </div>
      <div>
        <label for="reject">reject (kommasepariert)</label>
        <input id="reject" type="text" placeholder="z. B. Zebra, Elefant, …">
      </div>
      <div>
        <label for="explain">explain</label>
        <input id="explain" type="text" placeholder="Begründung/Hinweis">
      </div>
    </div>

    <div class="row inline">
      <div>
        <label for="Task1">Task1</label>
        <select id="Task1">
          <option value="">–</option>
          <option>Context</option>
          <option>Character</option>
          <option>Sequenz</option>
          <option>Bridging</option>
          <option>Emotion</option>
          <option>Intention/Thought</option>
          <option>Status inference</option>
          <option>Causal inference</option>
        </select>
      </div>
      <div>
        <label for="Task2">Task2</label>
        <select id="Task2">
          <option value="">–</option>
          <option>Context</option>
          <option>Character</option>
          <option>Sequenz</option>
          <option>Bridging</option>
          <option>Emotion</option>
          <option>Intention/Thought</option>
          <option>Status inference</option>
          <option>Causal inference</option>
        </select>
      </div>
      <div>
        <label for="Task3">Task3</label>
        <select id="Task3">
          <option value="">–</option>
          <option>Context</option>
          <option>Character</option>
          <option>Sequenz</option>
          <option>Bridging</option>
          <option>Emotion</option>
          <option>Intention/Thought</option>
          <option>Status inference</option>
          <option>Causal inference</option>
        </select>
      </div>
      <div>
        <label for="Context">Context</label>
        <select id="Context">
          <option value="">–</option>
          <option>KIND</option>
          <option>ERW</option>
          <option>FIK</option>
          <option>REAL</option>
          <option>Neutral</option>
        </select>
      </div>
    </div>

    <div class="row inline">
      <div>
        <label for="Gender">Gender</label>
        <input id="Gender" type="text" placeholder="z. B. W;M">
      </div>
      <div>
        <label for="Name">Name</label>
        <input id="Name" type="text" placeholder="z. B. Marie;Jonathan">
      </div>
      <div></div><div></div>
    </div>

    <p id="msg"></p>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const setMsg = (t, ok=false) => { const m = $("#msg"); m.textContent = t; m.className = ok ? "ok" : "err"; };

    // Live-Preview (einfaches Rendern – in Produktion: serverseitig sanitizen!)
    function bindPreview(textareaId, previewId, isPlain=false) {
      const ta = $(textareaId), pv = $(previewId);
      const render = () => {
        const v = ta.value || "";
        if (isPlain) { pv.textContent = v; }
        else { pv.innerHTML = v; } // ⚠️ Nur für Admin-UI. Live-Ausspielung: sanitizen!
      };
      ta.addEventListener("input", render);
      render();
    }

    bindPreview("#que",         "#prev-que");
    bindPreview("#que2a",       "#prev-que2a");
    bindPreview("#tbar",        "#prev-tbar", true);
    bindPreview("#que2b",       "#prev-que2b");
    bindPreview("#tts_que2b",   "#prev-tts_que2b", true);

    function fillForm(d) {
      $("#type").value  = d.type ?? "mc";
      $("#que").value   = d.que ?? "";
      $("#que2a").value = d.que2a ?? "";
      $("#tbar").value  = d.tbar ?? d.tts_text_que2a ?? "";
      $("#que2b").value = d.que2b ?? "";
      $("#tts_que2b").value = d.tts_text_que2b ?? "";

      $("#opt1").value  = d.opt1 ?? "";
      $("#opt2").value  = d.opt2 ?? "";
      $("#opt3").value  = d.opt3 ?? "";
      $("#opt4").value  = d.opt4 ?? "";
      $("#fb1").value   = d.fb1 ?? "";
      $("#fb2").value   = d.fb2 ?? "";
      $("#fb3").value   = d.fb3 ?? "";
      $("#fb4").value   = d.fb4 ?? "";
      $("#cor").value   = (d.cor ?? 1);
      $("#accept").value= Array.isArray(d.accept) ? d.accept.join(", ") : (d.accept ?? "");
      $("#reject").value= Array.isArray(d.reject) ? d.reject.join(", ") : (d.reject ?? "");
      $("#explain").value = d.explain ?? "";
      $("#Task1").value = d.Task1 ?? "";
      $("#Task2").value = d.Task2 ?? "";
      $("#Task3").value = d.Task3 ?? "";
      $("#Context").value = d.Context ?? "";
      $("#Gender").value  = d.Gender ?? "";
      $("#Name").value    = d.Name ?? "";

      // Previews aktualisieren
      ["#que","#que2a","#tbar","#que2b","#tts_que2b"].forEach((id)=> {
        const ev = new Event("input"); $(id).dispatchEvent(ev);
      });
    }

    // Laden
    $("#load").addEventListener("click", async () => {
      const id = Number($("#itemId").value);
      if (!id) return setMsg("Bitte gültige Item-ID angeben.");
      try {
        const r = await fetch(`/api/item-admin/items?ids=${id}`);
        if (!r.ok) throw new Error(await r.text());
        const arr = await r.json();
        if (!arr.length) { setMsg("Kein Item gefunden."); return; }
        fillForm(arr[0]);
        setMsg("Item geladen.", true);
      } catch (e) {
        setMsg("Fehler beim Laden: " + e.message);
      }
    });

    // Speichern
    $("#save").addEventListener("click", async () => {
      const token = $("#adminToken").value.trim();
      if (!token) return setMsg("Bitte Admin-Token eintragen.");

      const item = Number($("#itemId").value);
      if (!item) return setMsg("Item-ID fehlt.");

      const cor = Number($("#cor").value);
      const type = $("#type").value || "mc";
      if (type === "mc" && (isNaN(cor) || cor < 1 || cor > 4)) {
        return setMsg("cor muss 1–4 sein (für MC).");
      }

      const payload = {
        item,
        type,
        que: $("#que").value,
        que2a: $("#que2a").value,
        tbar: $("#tbar").value,               // TTS zu que2a
        que2b: $("#que2b").value,
        tts_text_que2b: $("#tts_que2b").value, // TTS zu que2b

        opt1: $("#opt1").value,
        opt2: $("#opt2").value,
        opt3: $("#opt3").value,
        opt4: $("#opt4").value,

        fb1: $("#fb1").value,
        fb2: $("#fb2").value,
        fb3: $("#fb3").value,
        fb4: $("#fb4").value,

        explain: $("#explain").value,
        cor: type === "mc" ? cor : null,
        accept: $("#accept").value,  // CSV-String; bei Bedarf auf Serverseite splitten
        reject: $("#reject").value,

        Task1: $("#Task1").value,
        Task2: $("#Task2").value,
        Task3: $("#Task3").value,
        Context: $("#Context").value,

        Gender: $("#Gender").value,
        Name: $("#Name").value
      };

      try {
        const r = await fetch("/api/item-admin/items", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify(payload)
        });
        if (!r.ok) throw new Error(await r.text());
        setMsg("Gespeichert.", true);
      } catch (e) {
        setMsg("Fehler beim Speichern: " + e.message);
      }
    });
  </script>
</body>
</html>
