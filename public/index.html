<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <title>LESEKIDS MISSON</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Styles -->
    <link rel="stylesheet" href="jspsych/dist/jspsych.css" />
    <link rel="stylesheet" href="css/text-container.css" />
    <link rel="stylesheet" href="css/tooltip.css" />
    <link rel="stylesheet" href="css/feedback-audio.css" />
    <link rel="stylesheet" href="css/univers.css" />
    <link rel="stylesheet" href="css/fuel.css" />

    <!-- jsPsych + Plugins -->
    <script src="/jspsych/dist/jspsych.js"></script>
    <script src="/jspsych/dist/plugin-html-button-response.js"></script>
    <script src="/jspsych/dist/plugin-survey-text.js"></script>
    <script src="/jspsych/dist/plugin-instructions.js"></script>
    <script src="/jspsych/dist/plugin-survey-multi-choice.js"></script>
    <script src="/jspsych/dist/plugin-call-function.js"></script>

    <!-- App-Utils (m√ºssen vor start() geladen sein) -->
    <script src="/js/utils.js"></script>
    <!-- <script>window.API_BASE = 'http://localhost:3000';</script> -->
    <script src="/js/api.js"></script>

    <!-- Rest deiner App -->
    <script src="/js/feedback-audio.js"></script>
    <script src="/js/score.js"></script>
    <script src="/js/item-selection.js"></script>
    <script src="/js/inject-mission-css.js"></script>
    <script src="/js/demo-questions.js"></script>
    <script src="/js/question-maker.js"></script>
    <script src="/js/feedback-maker.js"></script>
    <!-- Test-Item Button Layout Fixes -->
    <style>
      .test-item .jspsych-btn-group-flex,
      .test-item .jspsych-btn-group-grid {
        display: block !important;
        text-align: left !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        max-width: none !important;
      }
      .test-item .jspsych-btn {
        display: block !important;
        margin: 0.75em 0;
        padding: 0.9em 1.4em !important;
      }
    </style>
  </head>

  <body>
    <script>
      /* ============================================================
       * 0) jsPsych Init
       * ============================================================ */
      const jsPsych = initJsPsych({
        experiment_width: 750,
        show_progress_bar: false,
        on_close: function () {
          fetch("/api/save", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(jsPsych.data.get().values()),
          })
            .then((r) => {
              if (!r.ok) throw new Error("Fehler beim Speichern");
              return r.text();
            })
            .then((msg) => console.log("Erfolgreich gespeichert:", msg))
            .catch((e) => console.error("Fehler beim Speichern:", e));
          }
      });

      /* ============================================================
       * 1) Helper: Demografie ‚Äì Serverstatus & Speichern
       * ============================================================ */
      async function fetchDemStatus(subject_id) {
        const res = await fetch(`/api/demographics/status/${encodeURIComponent(subject_id)}`);
        if (!res.ok) throw new Error(`Status-Check fehlgeschlagen: ${res.status}`);
        const data = await res.json();
        return data.completed === true;
      }

      async function saveDemographics(payload) {
        const res = await fetch(`/api/demographics`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (res.status === 409) {
          // bereits vorhanden -> als ‚Äûerledigt‚Äú akzeptieren
          return { ok: true, alreadySaved: true };
        }
        if (!res.ok) {
          const t = await res.text().catch(() => "");
          throw new Error(`Speichern fehlgeschlagen (${res.status}): ${t}`);
        }
        return { ok: true, alreadySaved: false };
      }


      // Sammeln + Speichern nach Demo
      const saveDemBlock = {
        type: jsPsychCallFunction,
        async: true,
        func: async (done) => {
          try {
            // Antworten der drei survey-Seiten einsammeln:
            const d1 = jsPsych.data.get().filter({ trial_type: "survey-multi-choice" }).values()[0] || {};
            const d2 = jsPsych.data.get().filter({ trial_type: "survey-multi-choice" }).values()[1] || {};
            const d3 = jsPsych.data.get().filter({ trial_type: "survey-multi-choice" }).values()[2] || {};

            const r1 = d1.response || {};
            const r2 = d2.response || {};
            const r3 = d3.response || {};

            const payload = mapDemoResponses(r1, r2, r3);
            payload.subject_id = subject_id;
            await saveDemographics(payload);

            // localStorage Flag als UX-Fallback
            localStorage.setItem(`dem_completed__${subject_id}`, "1");
            done();
          } catch (e) {
            console.error(e);
            done(); // Test nicht blockieren
          }
        },
      };

      // Wenn n√∂tig Demografie-Sequenz anh√§ngen
      async function pushDemIfNeeded(timeline) {
        const lsDone = localStorage.getItem(`dem_completed__${subject_id}`) === "1";
        let serverDone = false;
        try {
          serverDone = await fetchDemStatus(subject_id);
        } catch (e) {
          console.warn("Server-Status nicht verf√ºgbar, nutze nur localStorage:", e);
        }
        if (lsDone || serverDone) {
          console.log("Demografie bereits vorhanden ‚Äì √ºberspringe Demobl√∂cke.");
          return timeline;
        }
        timeline.push(demo1, demo2, demo3, saveDemBlock, instructions3);
        return timeline;
      }

      /* ============================================================
       * 3) Konstanten & globale Referenzen
       * ============================================================ */
      const ITEMS_PER_SESSION = 10;
      window.items = []; // Auswahl der Items der Session

      /* ============================================================
       * 4) Mission-Control CSS + Renderer
       * ============================================================ */

      const safe = (v) => (v === null || v === undefined ? "‚Äì" : v);

      function renderMissionControl({ points = 0, days = 0, last = "‚Äì", tasks = 0, theta = "‚Äî" }) {
        const thetaStr = typeof theta === "number" ? theta.toFixed(3) : theta;
        return `
          <section class="lk-console" role="region" aria-label="Lesekids Mission Control">
            <h3 class="lk-title-mini"><span aria-hidden="true">üöÄ</span> LESKIDS MISSION CONTROL</h3>
            <div class="lk-status" aria-label="Systemstatus LEDs">
              <span class="lk-led lk-led--ok" title="Systemstatus: OK"></span>
              <span class="lk-led lk-led--link" title="Funkverbindung stabil"></span>
              <span class="lk-led lk-led--power" title="Energieversorgung nominal"></span>
            </div>
            <article class="lk-card" aria-label="Status">
              <h4 class="lk-card-title">üì° Statusbericht</h4>
              <dl class="lk-readouts">
                <div><dt>Plasma‚ÄëTreibstoff</dt>   <dd><strong>${safe(points)}</strong></dd></div>
                <div><dt>Missionstage aktiv</dt>  <dd><strong>${safe(days)}</strong></dd></div>
                <div><dt>Letzter Funkkontakt</dt> <dd><strong>${safe(last)}</strong></dd></div>
                <div><dt>Abgeschlossene Module</dt><dd><strong>${safe(tasks)}</strong></dd></div>
                <div><dt>üß≠ Navigator‚ÄëSkill Œ∏</dt> <dd><strong>${thetaStr}</strong></dd></div>
              </dl>
            </article>
          </section>
        `;
      }

      function renderMissionNotice({ variant = "info", title = "", description = "", chip = "" }) {
        const cls = variant === "locked" ? "is-locked" : (variant === "done" ? "is-done" : "");
        const icon = variant === "locked" ? "üîí" : (variant === "done" ? "‚úÖ" : "üõ∞Ô∏è");
        return `
          <article class="lk-alert ${cls}" aria-live="polite">
            <h4>${icon} ${title}${chip ? ` <span class="lk-chip">${chip}</span>` : ""}</h4>
            <p>${description}</p>
          </article>
        `;
      }

      function formatSigned(num, { digits = 0 } = {}) {
        if (num === null || num === undefined || Number.isNaN(num)) return "‚Äî";
        const n = typeof num === "number" ? num : Number(num);
        return n.toFixed(digits).replace(/^-0(\.0+)?$/, "0"); // -0 -> 0
      }

      function renderDeltaStrip({ pointsDelta = 0, thetaDelta = null }) {
        const pPos = (pointsDelta ?? 0) >= 0;
        const tPos = (thetaDelta ?? 0) >= 0;

        const thetaText = (thetaDelta === null || Number.isNaN(thetaDelta))
          ? "‚Äî"
          : formatSigned(Math.abs(thetaDelta), { digits: 3 });

        return `
          <div class="lk-deltas" role="group" aria-label="Ver√§nderungen dieser Session">
            <div class="lk-delta ${pPos ? "pos" : "neg"}" title="Punktever√§nderung in dieser Session">
              <span class="label">+Œî Punkte</span>
              <span class="val">${formatSigned(Math.abs(pointsDelta), { digits: 0 })}</span>
            </div>
            <div class="lk-delta ${tPos ? "pos" : "neg"}" title="√Ñnderung Navigator‚ÄëSkill Œ∏">
              <span class="label">ŒîŒ∏</span>
              <span class="val">${thetaText}</span>
            </div>
          </div>
        `;
      }

      /* ============================================================
       * 5) Subject-ID
       * ============================================================ */
      function getSubjectIdFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("id") || jsPsych.randomization.randomInt(100000000, 999999999);
      }
      const subject_id = getSubjectIdFromURL();
      jsPsych.data.addProperties({ subject_id });

      /* ============================================================
       * 6) Startlogik (zur urspr√ºnglichen Version)
       * ============================================================ */
/** ------------------------------------------------
 * Orchestrator: Demografie zuerst (falls n√∂tig),
 * danach Haupt‚ÄëExperiment starten
 * ------------------------------------------------ */
async function boot() {
  if (window.__LK_BOOT_LOCK__) return;
  window.__LK_BOOT_LOCK__ = true;

  injectMissionControlCSS();

  // 1) Check: Ist Demografie bereits abgeschlossen?
  let needsDemo = true;
  try {
    const lsDone = localStorage.getItem(`dem_completed__${subject_id}`) === "1";
    const serverDone = await fetchDemStatus(subject_id).catch(() => lsDone);
    needsDemo = !(lsDone || serverDone);
  } catch {
    needsDemo = true; // konservativ
  }

  if (!needsDemo) {
    // ‚Üí direkt mit dem Haupt‚ÄëExperiment loslegen
    startMainExperiment();
    return;
  }

  // 2) Demografie-Experiment als eigene, abgeschlossene Timeline
  const demoTimeline = [
    demo1,
    demo2,
    demo3,
    saveDemBlock,
    instructions3,
    {
      // kleiner Abschluss-Screen (optional h√ºbsch machen)
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="card">
          <h3>Super, danke!</h3>
          <p>Wir starten jetzt deine Mission.</p>
        </div>`,
      choices: ["Weiter üöÄ"]
    },
    {
      // ‚ÄûHandover‚Äú: nach dem Klick direkt Haupt‚ÄëExperiment starten
      type: jsPsychCallFunction,
      func: () => {
        // Kleines Delay, damit der vorherige Trial sauber schlie√üt
        setTimeout(() => startMainExperiment(), 0);
      }
    }
  ];

  jsPsych.run(demoTimeline);
}


      /** ------------------------------------------------
 * Haupt‚ÄëExperiment (war vorher in start())
 * ------------------------------------------------ */
async function startMainExperiment() {
  try {
    // --- Daten laden ---
    const [summary, thetaData, completedItems, selectionParams] = await Promise.all([
      loadSubjectSummary(subject_id),
      loadTheta(subject_id),
      loadCompletedItems(subject_id),
      loadItemParamsForSelection(),
    ]);

        if (window.__LK_START_LOCK__) return;
        window.__LK_START_LOCK__ = true;

        if (typeof window.loadSubjectSummary !== "function") {
          console.error("api.js nicht geladen ‚Äì loadSubjectSummary fehlt.");
          alert("Fehler: API-Funktionen nicht verf√ºgbar. Pr√ºfe, ob js/api.js vor diesem Script geladen wird.");
          return;
        }

        injectMissionControlCSS();

        // Timeline vorbereiten, optional mit Demografie
        let timeline = [];
        timeline = await pushDemIfNeeded(timeline);


        // Baseline (f√ºr End‚ÄëDelta)
        window.__LK_BASELINE = {
          points: Number.isFinite(summary?.total_points) ? summary.total_points : 0,
          theta: (thetaData && typeof thetaData.theta === "number") ? thetaData.theta : null
        };

        // Defaults & Œ∏
        const DEFAULTS = {
          threshold_1: -1,
          threshold_2: 0,
          first_threshold: 2000,
          points_first_try: 60,
          points_later_try: 40,
          weight: 1,
        };
        const theta = (thetaData && typeof thetaData.theta === "number") ? thetaData.theta : 0;

        // Bereits erledigte Items rausfiltern
        const itemsWithParams = selectionParams; // direkt nutzen
        const completedSet = new Set((completedItems || []).map(x => String(x)));
        const remainingItems = itemsWithParams.filter(it => !completedSet.has(String(it.item)));

        // Gewichtung
        const weights = remainingItems.map(it =>
          normalPDF(it.threshold_2, theta, 1) * (Number.isFinite(it.weight) ? it.weight : 1)
        );

        // Ziehung
        const pick = Math.min(ITEMS_PER_SESSION, remainingItems.length);
        const selected = weightedSampleWithoutReplacement(remainingItems, weights, pick);
        const selectedIds = selected.map(it => it.item);

        // Inhalte laden
        const selectedFull = await loadItemsByIds(selectedIds);
        const selectedItems = selectedFull || [];
        window.items = selectedItems;

        // Mission-Control Panel (oben)
        const panelHTML = renderMissionControl({
          points: summary ? summary.total_points : 0,
          days: summary ? summary.days_with_entries : 0,
          last: summary ? summary.last_entry_date : "‚Äì",
          tasks: summary ? summary.num_tasks_completed : 0,
          theta: (thetaData && thetaData.theta != null) ? thetaData.theta : "‚Äî",
        });

        // Tageslimit / alle Items fertig?
        const today = new Date().toISOString().slice(0, 10);
        const alreadyDoneToday = summary && summary.last_entry_date === today;

        if (alreadyDoneToday) {
          const blockTrial = {
            type: jsPsychHtmlButtonResponse,
            stimulus: () => {
              const notice = renderMissionNotice({
                variant: "locked",
                title: "Heute ist die Mission abgeschlossen",
                description: "Du hast heute schon alles gemacht. Morgen geht‚Äôs weiter.",
                chip: "Tageslimit",
              });
              return `
                <div class="card">
                  <img src="img/lesekids_logo.png" alt="LeseKI:DS Logo" class="logo" />
                  <h2>Hallo, ${subject_id}</h2>
                  ${notice}
                  ${panelHTML}
                </div>
              `;
            },
            choices: ["OK"],
            on_finish: (d) => (d.stimulus = -9),
            data: { type: 0 },
          };
          jsPsych.run([blockTrial]);
          return;
        }

        if (remainingItems.length === 0) {
          const finishedAll = {
            type: jsPsychHtmlButtonResponse,
            stimulus: () => {
              const notice = renderMissionNotice({
                variant: "done",
                title: `Alle Module abgeschlossen, ${subject_id}!`,
                description: "Du hast bereits alle verf√ºgbaren Aufgaben erfolgreich bearbeitet.",
                chip: "100%",
              });
              return `
                <div class="card">
                  <img src="img/lesekids_logo.png" alt="LeseKI:DS Logo" class="logo" />
                  ${notice}
                  ${panelHTML}
                </div>
              `;
            },
            choices: ["OK"],
          };
          jsPsych.run([finishedAll]);
          return;
        }

        /* -------------------------------------------
         * 6a) Start-Trial (Mission-Control)
         * ------------------------------------------- */
        const tplButton = (choice) => `<button class="jspsych-btn">${choice}</button>`;
        const startTrial = {
          type: jsPsychHtmlButtonResponse,
          stimulus: () => {
            const header = `
              <div class="card">
                <img src="img/lesekids_logo.png" alt="LeseKI:DS Logo" class="logo" />
                <h2>Willkommen bei Lesekids‚ÄëQuiz, ${subject_id}</h2>
            `;
            const footer = `
                <p style="margin-top:1rem;">Klicke auf ‚ÄûStart‚Äú, um fortzufahren.</p>
              </div>
            `;
            return `${header}${panelHTML}${footer}`;
          },
          choices: ["Start üöÄ"],
          button_html: (choice) => tplButton(choice),
          on_finish: (d) => (d.stimulus = -1),
          data: { type: 0 },
        };

        /* -------------------------------------------
         * 6b) Frage-Loops (MC + offene Items)
         * ------------------------------------------- */
window.totalPoints = 0;
window.tasksCompleted = 0;
window.scoredItems = [];

        /* -------------------------------------------
         * 6c) Timeline aufbauen
         * ------------------------------------------- */
        const main_timeline = [startTrial];

        selectedItems.forEach((item) => {
          const qTrial = makeQuestionTrial(item);
          const fbNode = makeFeedbackNode(selectedItems);
          const loop_node = {
            timeline: [qTrial, fbNode],
            loop_function: function () {
              const lastQuestion = jsPsych.data.get().last(2).values()[0];
              return !(
                (lastQuestion.correct && !lastQuestion.rt_fast) ||
                lastQuestion.show_explain === true
              );
            },
          };
          main_timeline.push(loop_node);
        });

        // Speichern + End-Summary
        let finalSummary = null;
        let finalTheta = null;

        const saveAndFetchTrial = {
          type: jsPsychHtmlButtonResponse,
          stimulus: `<p>Speichere ‚Ä¶</p>`,
          choices: [],
          on_load: async () => {
            try {
              await saveAllData();
              await new Promise((r) => setTimeout(r, 150));
              let tries = 0; let s = null;
              while (tries < 5 && !s) {
                s = await loadSubjectSummary(subject_id);
                if (!s) await new Promise((r) => setTimeout(r, 200));
                tries++;
              }
              finalSummary = s;
              finalTheta = await loadTheta(subject_id);
            } catch (e) {
              console.error("Save/Fetch-Fehler:", e);
              finalSummary = finalSummary ?? null;
              finalTheta = finalTheta ?? null;
            } finally {
              jsPsych.finishTrial();
            }
          },
        };

        const endSummaryTrial = {
          type: jsPsychHtmlButtonResponse,
          stimulus: () => {
            injectMissionControlCSS();
            const s = finalSummary || {};
            const t = finalTheta   || {};
            const panel = renderMissionControl({
              points: Number.isFinite(s.total_points) ? s.total_points : 0,
              days:   Number.isFinite(s.days_with_entries) ? s.days_with_entries : 0,
              last:   s.last_entry_date || "‚Äì",
              tasks:  Number.isFinite(s.num_tasks_completed) ? s.num_tasks_completed : 0,
              theta:  (t && typeof t.theta === "number") ? t.theta : "‚Äî"
            });

            // Deltas gegen Baseline vom Start
            const base = window.__LK_BASELINE || { points: 0, theta: null };
            const pointsDelta = (Number.isFinite(s.total_points) ? s.total_points : 0) - (Number.isFinite(base.points) ? base.points : 0);
            let thetaDelta = null;
            const thetaNow  = (t && typeof t.theta === "number") ? t.theta : null;
            if (thetaNow !== null && typeof base.theta === "number") thetaDelta = thetaNow - base.theta;
            const deltas = renderDeltaStrip({ pointsDelta, thetaDelta });

            const notice = renderMissionNotice({
              variant: "done",
              title: "Mission abgeschlossen",
              description: "Deine Ergebnisse wurden gespeichert. Gute Arbeit, Pilot:in!",
              chip: "Session"
            });

            return `
              <div class="card">
                <img src="img/lesekids_logo.png" alt="LeseKI:DS Logo" class="logo" />
                <h2>Mission abgeschlossen ‚Äì Zusammenfassung</h2>
                ${notice}
                ${deltas}
                ${panel}
                <p style="margin-top:.8rem;">Du kannst das Fenster jetzt schlie√üen.</p>
              </div>
            `;
          },
          choices: ["Fertig"]
        };

        main_timeline.push(saveAndFetchTrial, endSummaryTrial);

        // Alles in die Timeline
        timeline.push(...main_timeline);

        // Abflug!
        jsPsych.run(timeline);
  } catch (e) {
    console.error(e);
    jsPsych.run([{
      type: jsPsychHtmlButtonResponse,
      stimulus: `<p>‚ö†Ô∏è Ein Fehler ist aufgetreten. Bitte versuche es sp√§ter erneut.</p>`,
      choices: ["Schlie√üen"]
    }]);
  }
}
      // Kickoff
    

window.addEventListener('DOMContentLoaded', boot);




    </script>
  </body>
</html>
