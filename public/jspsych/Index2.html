<!DOCTYPE html>
<html>
  <head>
    <title>2 Versuche pro Frage</title>
    <script src="jspsych/dist/jspsych.js"></script>
    <script src="jspsych/dist/plugin-html-button-response.js"></script>
    <script src="jspsych/dist/plugin-html-keyboard-response.js"></script>
    <link href="jspsych/dist/jspsych.css" rel="stylesheet" />
  </head>
  <body></body>
  <script>
    const jsPsych = initJsPsych();

    // üìå Fragenliste
    const timeline_variables = [
      {
        item: 1,
        que: "Warum teilt Susi ihr Br√∂tchen?",
        opt: [
          "Weil sie Karin helfen will.",
          "Weil sie wenig Hunger hat.",
          "Weil sie ihr Fr√ºhst√ºck immer teilt.",
          "Weil Fr√ºhst√ºckspause ist."
        ],
        cor: 0
      },
      {
        item: 2,
        que: "Warum holt Paul eine Leiter aus dem Keller?",
        opt: [
          "Weil er Fu√üballprofi werden m√∂chte.",
          "Weil sie mit dem Ball nach drau√üen gehen wollen.",
          "Weil er ohne Leiter nicht an den Ball heran kommt.",
          "Weil er den Ball auf dem Schrank verstecken will."
        ],
        cor: 2
      }
    ];

    const main_timeline = [];

    timeline_variables.forEach((trial_data) => {
      let incorrect_response_index = null;
      let answered_correctly = false;

      // Versuch 1
      const question1 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: trial_data.que,
        choices: trial_data.opt,
        data: {
          item: trial_data.item,
          correct_response: trial_data.cor,
          attempt: 1
        },
        on_finish: function (data) {
          data.correct = data.response == data.correct_response;
          if (!data.correct) {
            incorrect_response_index = data.response;
          } else {
            answered_correctly = true;
          }
        }
      };

      // Feedback nach Versuch 1 (wenn falsch)
      const feedback1 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: "<p style='color:red;'>Leider falsch. Du hast noch einen Versuch.</p><p>Dr√ºcke eine Taste, um fortzufahren.</p>",
        choices: ["ALL_KEYS"],
        conditional_function: () => !answered_correctly
      };

      // Versuch 2 (ohne falsche Option)
      const question2 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: trial_data.que,
        choices: () => {
          const choices_copy = [...trial_data.opt];
          if (incorrect_response_index !== null) {
            choices_copy[incorrect_response_index] = null; // entfernt
          }
          return choices_copy.filter((opt) => opt !== null);
        },
        data: {
          item: trial_data.item,
          correct_response: trial_data.cor,
          attempt: 2
        },
        conditional_function: () => !answered_correctly,
        on_finish: function (data) {
          // Antwortindex anpassen, weil eine Option entfernt wurde
          const filtered_choices = trial_data.opt.filter((_, i) => i !== incorrect_response_index);
          const adjusted_index = trial_data.opt.findIndex((opt, i) => i !== incorrect_response_index && opt === filtered_choices[data.response]);
          data.response_original_index = adjusted_index;
          data.correct = adjusted_index === trial_data.cor;
        }
      };

      // Feedback nach Versuch 2
      const feedback2 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: function () {
          const last = jsPsych.data.get().last(1).values()[0];
          return last.correct
            ? "<p style='color:green;'>Richtig! Gut gemacht.</p><p>Dr√ºcke eine Taste, um fortzufahren.</p>"
            : "<p style='color:red;'>Leider falsch. Die richtige Antwort war: " +
                trial_data.opt[trial_data.cor] +
                "</p><p>Dr√ºcke eine Taste, um fortzufahren.</p>";
        },
        choices: ["ALL_KEYS"]
      };

      main_timeline.push(question1, feedback1, question2, feedback2);
    });

    jsPsych.run(main_timeline);
  </script>
</html>
